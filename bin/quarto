#!/usr/bin/env bash
set -euo pipefail

# Wrapper for Quarto on macOS when sysctl is blocked.
QUARTO_HOME="${QUARTO_HOME:-/Applications/quarto}"
QUARTO_BIN_PATH="${QUARTO_HOME}/bin"
QUARTO_SHARE_PATH="${QUARTO_SHARE_PATH:-${QUARTO_HOME}/share}"
QUARTO_TARGET="${QUARTO_BIN_PATH}/quarto.js"

if [[ "$(uname -s)" != "Darwin" ]]; then
  echo "quarto wrapper is intended for macOS; use the system quarto instead." >&2
  exit 1
fi

ARCH="$(uname -m)"
case "${ARCH}" in
  x86_64) ARCH_DIR="x86_64" ;;
  arm64|aarch64) ARCH_DIR="aarch64" ;;
  *) echo "quarto wrapper failed: unrecognized architecture ${ARCH}" >&2; exit 1 ;;
esac

export QUARTO_BIN_PATH
export QUARTO_SHARE_PATH
export DENO_DOM_PLUGIN="${QUARTO_BIN_PATH}/tools/${ARCH_DIR}/deno_dom/libplugin.dylib"
export QUARTO_DENO="${QUARTO_BIN_PATH}/tools/${ARCH_DIR}/deno"

export DENO_TLS_CA_STORE=system,mozilla
export DENO_NO_UPDATE_CHECK=1

QUARTO_CACHE_OPTIONS="--cached-only"
QUARTO_DENO_OPTIONS="--no-check"
QUARTO_DENO_OPTIONS="--unstable-ffi --unstable-kv --no-config --no-lock ${QUARTO_CACHE_OPTIONS} --allow-all ${QUARTO_DENO_OPTIONS}"

if [[ -n "${QUARTO_DENO_V8_OPTIONS:-}" ]]; then
  QUARTO_DENO_V8_OPTIONS="--enable-experimental-regexp-engine,--max-old-space-size=8192,--max-heap-size=8192,${QUARTO_DENO_V8_OPTIONS}"
else
  QUARTO_DENO_V8_OPTIONS="--enable-experimental-regexp-engine,--max-old-space-size=8192,--max-heap-size=8192"
fi

if [[ -n "${QUARTO_DENO_EXTRA_OPTIONS:-}" ]]; then
  QUARTO_DENO_EXTRA_OPTIONS="--v8-flags=${QUARTO_DENO_V8_OPTIONS} ${QUARTO_DENO_EXTRA_OPTIONS}"
else
  QUARTO_DENO_EXTRA_OPTIONS="--v8-flags=${QUARTO_DENO_V8_OPTIONS}"
fi

exec "${QUARTO_DENO}" run ${QUARTO_DENO_OPTIONS} ${QUARTO_DENO_EXTRA_OPTIONS} "${QUARTO_TARGET}" "$@"
